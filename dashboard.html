<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>DepRadar â€” Dependency Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#09090b;--card:#18181b;--card-hover:#1f1f23;--border:#27272a;--border-light:#3f3f46;
--text:#fafafa;--dim:#71717a;--ok:#22c55e;--ok-bg:rgba(34,197,94,.12);--warn:#f59e0b;
--warn-bg:rgba(245,158,11,.12);--danger:#ef4444;--danger-bg:rgba(239,68,68,.12);
--accent:#2dd4bf;--accent-bg:rgba(45,212,191,.12);--purple:#60a5fa;
--radius:10px;--radius-lg:14px}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
.app{max-width:1200px;margin:0 auto;padding:24px}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:28px}
.logo h1{font-size:22px;font-weight:700;letter-spacing:-.5px}
.logo h1 span{background:linear-gradient(135deg,#2dd4bf,#60a5fa);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.logo-badge{font-size:11px;background:var(--accent-bg);color:var(--accent);padding:2px 8px;border-radius:20px;font-weight:500;margin-left:10px}
.header-meta{color:var(--dim);font-size:12px;margin-top:4px}
.btn{padding:8px 18px;border-radius:8px;font-size:13px;font-weight:500;cursor:pointer;border:none;transition:all .15s}
.btn-primary{background:var(--accent);color:#0c0a1c}.btn-primary:hover{background:#14b8a6}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-outline:hover{border-color:var(--border-light);background:var(--card)}
.btn-success{background:var(--ok);color:#fff}.btn-success:hover{background:#16a34a}
.btn-danger{background:var(--danger-bg);color:var(--danger);border:1px solid rgba(239,68,68,.2)}.btn-danger:hover{background:rgba(239,68,68,.2)}
.btn-sm{padding:5px 12px;font-size:12px;border-radius:6px}
.btn:disabled{opacity:.4;cursor:not-allowed}
</style>
<style>
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:28px}
.stat{background:var(--card);border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px;text-align:center}
.stat-val{font-size:32px;font-weight:700;line-height:1}
.stat-label{color:var(--dim);font-size:11px;text-transform:uppercase;letter-spacing:1px;margin-top:6px}
.projects{display:grid;gap:10px}
.project-row{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;display:grid;grid-template-columns:2fr 1fr auto auto auto auto;align-items:center;gap:16px;cursor:pointer;transition:all .15s}
.project-row:hover{background:var(--card-hover);border-color:var(--border-light)}
.proj-name{font-size:15px;font-weight:600;display:flex;align-items:center;gap:8px}
.proj-meta{color:var(--dim);font-size:12px;margin-top:3px}
.lang{display:inline-flex;width:22px;height:22px;border-radius:5px;align-items:center;justify-content:center;font-size:10px;font-weight:700;flex-shrink:0}
.lang-node{background:#3c873a;color:#fff}.lang-python{background:#3776ab;color:#fff}.lang-rust{background:#ce422b;color:#fff}
.lang-go{background:#00add8;color:#fff}.lang-php{background:#777bb4;color:#fff}.lang-ruby{background:#cc342d;color:#fff}
.lang-dart{background:#0175c2;color:#fff}.lang-swift{background:#f05138;color:#fff}.lang-kotlin{background:#7f52ff;color:#fff}
.badge{padding:3px 10px;border-radius:20px;font-size:12px;font-weight:500;white-space:nowrap}
.badge-ok{background:var(--ok-bg);color:var(--ok)}.badge-warn{background:var(--warn-bg);color:var(--warn)}.badge-danger{background:var(--danger-bg);color:var(--danger)}
.score{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:15px;flex-shrink:0}
.score-high{background:var(--ok-bg);color:var(--ok);border:2px solid rgba(34,197,94,.3)}
.score-mid{background:var(--warn-bg);color:var(--warn);border:2px solid rgba(245,158,11,.3)}
.score-low{background:var(--danger-bg);color:var(--danger);border:2px solid rgba(239,68,68,.3)}
.outdated-info{font-size:13px;color:var(--dim);text-align:right;min-width:100px}
.outdated-info strong{color:var(--text)}
.chevron{color:var(--dim);font-size:18px}
</style>
<style>
/* Detail slide-over */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:100;opacity:0;pointer-events:none;transition:opacity .2s}
.overlay.open{opacity:1;pointer-events:auto}
.detail{position:fixed;top:0;right:-720px;width:720px;height:100vh;background:var(--bg);border-left:1px solid var(--border);z-index:101;overflow-y:auto;transition:right .3s cubic-bezier(.4,0,.2,1)}
.detail.open{right:0}
.detail-header{padding:24px 28px;border-bottom:1px solid var(--border);position:sticky;top:0;background:var(--bg);z-index:10}
.detail-close{background:none;border:none;color:var(--dim);font-size:24px;cursor:pointer;padding:4px}
.detail-close:hover{color:var(--text)}
.detail-top{display:flex;justify-content:space-between;align-items:flex-start}
.detail-title{font-size:20px;font-weight:700}
.detail-meta{color:var(--dim);font-size:13px;margin-top:4px}
.detail-stats{display:flex;gap:12px;margin-top:16px;flex-wrap:wrap}
.detail-stat{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:13px}
.detail-stat strong{display:block;font-size:18px;margin-bottom:2px}
.detail-body{padding:24px 28px}
.health-bar{width:100%;height:6px;background:var(--card);border-radius:3px;margin-top:14px;overflow:hidden}
.health-fill{height:100%;border-radius:3px;transition:width .5s}
.actions-bar{display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.actions-bar .label{color:var(--dim);font-size:12px;text-transform:uppercase;letter-spacing:1px;margin-right:4px}
.eco-section{margin-bottom:24px}
.eco-header{font-size:13px;font-weight:600;color:var(--dim);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid var(--border)}
.eco-header .count{color:var(--text);font-weight:400;margin-left:8px}
.dep-row{display:grid;grid-template-columns:1fr auto auto auto;align-items:center;gap:12px;padding:10px 14px;border-radius:8px;margin-bottom:4px;transition:background .1s}
.dep-row:hover{background:var(--card)}
.dep-name{font-size:14px;font-weight:500}
.dep-versions{font-size:13px;color:var(--dim);display:flex;align-items:center;gap:6px}
.dep-versions .arrow{color:var(--accent)}.dep-versions .current{color:var(--dim)}.dep-versions .latest{color:var(--text);font-weight:500}
.dep-type{font-size:11px;font-weight:600;padding:2px 8px;border-radius:12px;text-transform:uppercase;letter-spacing:.5px}
.dep-type-patch{background:var(--ok-bg);color:var(--ok)}.dep-type-minor{background:var(--warn-bg);color:var(--warn)}.dep-type-major{background:var(--danger-bg);color:var(--danger)}
.update-result{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;font-size:13px}
.update-result pre{background:#000;padding:12px;border-radius:8px;overflow-x:auto;margin-top:8px;font-size:12px;color:var(--dim);font-family:'SF Mono',Monaco,monospace;max-height:200px}
.update-result .cmd{color:var(--accent);font-family:'SF Mono',Monaco,monospace;font-size:12px}
.reco-box{background:var(--accent-bg);border:1px solid rgba(59,130,246,.2);border-radius:var(--radius);padding:14px;margin-bottom:20px;font-size:13px;line-height:1.6}
.reco-box strong{color:var(--accent)}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:80px 20px;color:var(--dim)}.empty h2{color:var(--text);font-size:18px;margin-bottom:8px}
.tip{position:relative;cursor:help}
.tip:hover::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 6px);left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:4px 10px;border-radius:6px;font-size:11px;white-space:nowrap;z-index:50;pointer-events:none}
/* Toggle switch */
.toggle{position:relative;width:40px;height:22px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.toggle .slider{position:absolute;cursor:pointer;inset:0;background:var(--border);border-radius:22px;transition:.2s}
.toggle .slider::before{content:'';position:absolute;height:16px;width:16px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s}
.toggle input:checked+.slider{background:var(--ok)}
.toggle input:checked+.slider::before{transform:translateX(18px)}
.auto-label{font-size:11px;color:var(--dim);white-space:nowrap}
.auto-col{display:flex;align-items:center;gap:6px;justify-content:center}
@media(max-width:900px){.stats{grid-template-columns:repeat(3,1fr)}.project-row{grid-template-columns:1fr auto auto}.outdated-info,.chevron,.auto-col{display:none}.detail{width:100%}}
@media(max-width:600px){.stats{grid-template-columns:repeat(2,1fr)}.header{flex-direction:column;gap:12px}}
</style>
</head>
<body>
<div class="app">

<!-- Header -->
<div class="header">
  <div class="logo">
    <div>
      <h1><span>Dep</span>Radar<span class="logo-badge">v4.0</span></h1>
      <div class="header-meta" id="updated">No scan data yet</div>
    </div>
  </div>
  <div style="display:flex;gap:10px">
    <button class="btn btn-success" id="update-all-btn" onclick="updateAllProjects()" style="display:none">â¬† Update All Projects</button>
    <button class="btn btn-primary" id="scan-btn" onclick="triggerScan()">âŸ³ Scan All Projects</button>
    <button class="btn btn-outline" onclick="loadData()">Refresh</button>
  </div>
</div>

<!-- Stats -->
<div class="stats">
  <div class="stat"><div class="stat-val" id="s-total">0</div><div class="stat-label">Projects</div></div>
  <div class="stat"><div class="stat-val" id="s-ok" style="color:var(--ok)">0</div><div class="stat-label">Up to date</div></div>
  <div class="stat"><div class="stat-val" id="s-outdated" style="color:var(--warn)">0</div><div class="stat-label">Outdated</div></div>
  <div class="stat"><div class="stat-val" id="s-major" style="color:var(--danger)">0</div><div class="stat-label">Major</div></div>
  <div class="stat"><div class="stat-val" id="s-avg">â€”</div><div class="stat-label">Avg Health</div></div>
</div>

<!-- Projects list -->
<div class="projects" id="projects">
  <div class="empty"><h2>No scan data</h2><p>Click "Scan All Projects" to analyze your dependencies</p></div>
</div>
</div>

<!-- Detail slide-over -->
<div class="overlay" id="overlay" onclick="closeDetail()"></div>
<div class="detail" id="detail">
  <div class="detail-header">
    <div class="detail-top">
      <div>
        <div class="detail-title" id="d-title">â€”</div>
        <div class="detail-meta" id="d-meta">â€”</div>
      </div>
      <button class="detail-close" onclick="closeDetail()">âœ•</button>
    </div>
    <div class="detail-stats" id="d-stats"></div>
    <div class="health-bar"><div class="health-fill" id="d-health-bar"></div></div>
  </div>
  <div class="detail-body" id="d-body">
    <div style="text-align:center;padding:40px;color:var(--dim)"><span class="spinner"></span> Loading...</div>
  </div>
</div>

<script>
const LANG={node:'JS',python:'PY',rust:'RS',go:'GO',php:'PHP',ruby:'RB',dart:'DT',swift:'SW',kotlin:'KT'};
const TYPE_EXPLAIN={
  patch:'Bug fixes and security patches. Always safe to update.',
  minor:'New features, backwards compatible. Generally safe.',
  major:'Breaking changes. May require code modifications. Review changelog before updating.'
};
let allProjects=[];
let autoUpdateList=[];

async function loadAutoUpdate(){
  try{const r=await fetch('/api/autoupdate');const d=await r.json();autoUpdateList=d.autoUpdate||[];}catch(e){}
}

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}
function shortPath(p){return p.replace(/\/Users\/[^/]+\//,'~/')}
function timeAgo(d){const s=Math.floor((Date.now()-d)/1000);if(s<60)return 'just now';if(s<3600)return Math.floor(s/60)+'m ago';if(s<86400)return Math.floor(s/3600)+'h ago';return Math.floor(s/86400)+'d ago'}

// â”€â”€ Data loading â”€â”€
async function loadData(){
  try{
    await loadAutoUpdate();
    const r=await fetch('/api/status');
    const d=await r.json();
    allProjects=d.projects||[];
    renderOverview(d);
  }catch(e){console.error(e)}
}

function renderOverview(data){
  const p=data.projects||[];
  if(data.updatedAt){
    document.getElementById('updated').textContent='Last scan: '+timeAgo(new Date(data.updatedAt));
  }
  const btn=document.getElementById('scan-btn');
  btn.disabled=data.scanning;
  btn.innerHTML=data.scanning?'<span class="spinner"></span>Scanning...':'âŸ³ Scan All Projects';

  const ok=p.filter(x=>x.outdatedCount===0).length;
  const outdated=p.filter(x=>x.outdatedCount>0).length;
  const majors=p.reduce((a,x)=>a+(x.majorCount||0),0);
  const avg=p.length?Math.round(p.reduce((a,x)=>a+x.score,0)/p.length):0;

  document.getElementById('update-all-btn').style.display=outdated>0?'inline-block':'none';

  document.getElementById('s-total').textContent=p.length;
  document.getElementById('s-ok').textContent=ok;
  document.getElementById('s-outdated').textContent=outdated;
  document.getElementById('s-major').textContent=majors;
  const avgEl=document.getElementById('s-avg');
  avgEl.textContent=p.length?avg:'â€”';
  avgEl.style.color=avg>=80?'var(--ok)':avg>=50?'var(--warn)':'var(--danger)';

  const el=document.getElementById('projects');
  if(!p.length){el.innerHTML='<div class="empty"><h2>No scan data</h2><p>Click "Scan All Projects" to get started</p></div>';return}

  const sorted=[...p].sort((a,b)=>a.score-b.score);
  el.innerHTML=sorted.map(proj=>{
    const sc=proj.score>=80?'score-high':proj.score>=50?'score-mid':'score-low';
    const bc=proj.outdatedCount===0?'badge-ok':proj.majorCount>0?'badge-danger':'badge-warn';
    const bt=proj.outdatedCount===0?'âœ“ Up to date':proj.majorCount>0?proj.majorCount+' major':proj.outdatedCount+' outdated';
    const lang=LANG[proj.language]||proj.language;
    const name=proj.project;
    return `<div class="project-row" onclick="openDetail('${esc(name)}')">
      <div><div class="proj-name"><span class="lang lang-${proj.language}">${lang}</span>${esc(name)}</div>
      <div class="proj-meta">${esc(proj.framework)} Â· ${esc(shortPath(proj.path))}</div></div>
      <div class="outdated-info"><strong>${proj.outdatedCount}</strong> outdated${proj.majorCount?' Â· <span style="color:var(--danger)">'+proj.majorCount+' major</span>':''}</div>
      <span class="badge ${bc}">${bt}</span>
      <div class="score ${sc}">${proj.score}</div>
      <div class="auto-col" onclick="event.stopPropagation()">
        <label class="toggle"><input type="checkbox" ${autoUpdateList.includes(name)?'checked':''} onchange="toggleAutoUpdate('${esc(name)}',this.checked)"><span class="slider"></span></label>
        <span class="auto-label">Auto</span>
      </div>
      <div class="chevron">â€º</div>
    </div>`;
  }).join('');
}
</script>
<script>
// â”€â”€ Detail panel â”€â”€
async function openDetail(name){
  document.getElementById('overlay').classList.add('open');
  document.getElementById('detail').classList.add('open');
  document.getElementById('d-title').textContent=name;
  document.getElementById('d-meta').textContent='Loading...';
  document.getElementById('d-stats').innerHTML='';
  document.getElementById('d-health-bar').style.width='0%';
  document.getElementById('d-body').innerHTML='<div style="text-align:center;padding:40px;color:var(--dim)"><span class="spinner"></span> Scanning dependencies live...</div>';

  try{
    const r=await fetch('/api/project/'+encodeURIComponent(name));
    const d=await r.json();
    if(d.error){document.getElementById('d-body').innerHTML='<div class="empty">Error: '+esc(d.error)+'</div>';return}
    renderDetail(d);
  }catch(e){
    document.getElementById('d-body').innerHTML='<div class="empty">Error: '+esc(e.message)+'</div>';
  }
}

function renderDetail(d){
  const h=d.health||{};

  document.getElementById('d-title').textContent=d.project;
  document.getElementById('d-meta').textContent=[d.framework,d.language,d.packageManager,shortPath(d.path)].join(' Â· ');

  // Health bar
  const hb=document.getElementById('d-health-bar');
  hb.style.width=h.score+'%';
  hb.style.background=h.score>=80?'var(--ok)':h.score>=50?'var(--warn)':'var(--danger)';

  // Stats
  document.getElementById('d-stats').innerHTML=
    `<div class="detail-stat"><strong>${h.score}</strong>Health</div>`+
    `<div class="detail-stat"><strong>${d.outdatedCount}</strong>Outdated</div>`+
    `<div class="detail-stat"><strong>${d.majorCount}</strong>Major</div>`+
    `<div class="detail-stat"><strong>${d.securityIssues}</strong>Vulns</div>`;

  let html='';

  // Actions bar
  html+='<div class="actions-bar"><span class="label">Actions:</span>';
  if(d.outdatedCount>0){
    html+=`<button class="btn btn-success btn-sm" onclick="runUpdate('${esc(d.project)}','minor')">â¬† Safe update (patch + minor)</button>`;
    html+=`<button class="btn btn-danger btn-sm" onclick="runUpdate('${esc(d.project)}','latest')">â¬† Update all to latest</button>`;
    html+=`<button class="btn btn-outline btn-sm" onclick="dryRun('${esc(d.project)}')">Preview commands</button>`;
  }else{
    html+='<span style="color:var(--ok);font-size:14px">âœ“ All dependencies are up to date</span>';
  }
  const isAuto = autoUpdateList.includes(d.project);
  html+=`<div style="margin-left:auto;display:flex;align-items:center;gap:8px">
    <label class="toggle"><input type="checkbox" ${isAuto?'checked':''} onchange="toggleAutoUpdate('${esc(d.project)}',this.checked)"><span class="slider"></span></label>
    <span style="font-size:12px;color:var(--dim)">Auto-update</span>
  </div>`;
  html+='</div>';

  // Recommendations
  if(h.recommendations && h.recommendations.length){
    html+='<div class="reco-box"><strong>ðŸ’¡ Recommendations</strong><br>';
    html+=h.recommendations.map(r=>'Â· '+esc(r)).join('<br>');
    html+='</div>';
  }

  // Update result placeholder
  html+='<div id="update-result"></div>';

  // Ecosystem groups
  const groups=d.groups||{};
  const order=['svelte','supabase','tailwind','vite','typescript','react','vue','testing','build','linting','other'];
  const sortedKeys=[...Object.keys(groups)].sort((a,b)=>{
    const ai=order.indexOf(a),bi=order.indexOf(b);
    return (ai<0?99:ai)-(bi<0?99:bi);
  });

  for(const eco of sortedKeys){
    const deps=groups[eco];
    if(!deps||!deps.length)continue;
    const majors=deps.filter(d=>d.updateType==='major').length;
    const minors=deps.filter(d=>d.updateType==='minor').length;
    const patches=deps.filter(d=>d.updateType==='patch').length;

    html+=`<div class="eco-section">`;
    html+=`<div class="eco-header">${esc(eco)}<span class="count">${deps.length} packages`;
    if(majors)html+=` Â· <span style="color:var(--danger)">${majors} major</span>`;
    if(minors)html+=` Â· <span style="color:var(--warn)">${minors} minor</span>`;
    if(patches)html+=` Â· <span style="color:var(--ok)">${patches} patch</span>`;
    html+=`</span></div>`;

    // Sort: major first, then minor, then patch
    const sorted=[...deps].sort((a,b)=>typeOrd(a.updateType)-typeOrd(b.updateType));
    for(const dep of sorted){
      const tc='dep-type-'+dep.updateType;
      const tip=TYPE_EXPLAIN[dep.updateType]||'';
      html+=`<div class="dep-row">
        <div class="dep-name tip" data-tip="${esc(tip)}">${esc(dep.name)}</div>
        <div class="dep-versions">
          <span class="current">${esc(dep.current)}</span>
          <span class="arrow">â†’</span>
          <span class="latest">${esc(dep.latest)}</span>
        </div>
        <span class="dep-type ${tc}">${dep.updateType}</span>
        <button class="btn btn-outline btn-sm" onclick="runUpdate('${esc(d.project)}','latest','${esc(dep.name)}')">Update</button>
      </div>`;
    }
    html+='</div>';
  }

  if(!sortedKeys.length && d.outdatedCount===0){
    html+='<div class="empty" style="padding:40px"><h2 style="color:var(--ok)">âœ“ All clean!</h2><p>No outdated dependencies.</p></div>';
  }

  document.getElementById('d-body').innerHTML=html;
}

function typeOrd(t){return t==='major'?0:t==='minor'?1:2}
function closeDetail(){
  document.getElementById('overlay').classList.remove('open');
  document.getElementById('detail').classList.remove('open');
}
</script>
<script>
// â”€â”€ Update & Scan actions â”€â”€
async function runUpdate(project, level, packages){
  const el=document.getElementById('update-result');
  el.innerHTML='<div class="update-result"><span class="spinner"></span> Running update...</div>';

  try{
    const body={project, level};
    if(packages) body.packages=packages;
    const r=await fetch('/api/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const d=await r.json();

    if(d.success){
      el.innerHTML=`<div class="update-result" style="border-color:rgba(34,197,94,.3)">
        <strong style="color:var(--ok)">âœ“ Update successful</strong><br>
        <span class="cmd">$ ${esc(d.command)}</span>
        ${d.output?'<pre>'+esc(d.output)+'</pre>':''}
      </div>`;
      setTimeout(()=>openDetail(project),2000);
    }else{
      el.innerHTML=`<div class="update-result" style="border-color:rgba(239,68,68,.3)">
        <strong style="color:var(--danger)">âœ— Update failed</strong><br>
        <span class="cmd">$ ${esc(d.command)}</span>
        <pre>${esc(d.error||'Unknown error')}</pre>
      </div>`;
    }
  }catch(e){
    el.innerHTML=`<div class="update-result" style="border-color:rgba(239,68,68,.3)"><strong style="color:var(--danger)">Error:</strong> ${esc(e.message)}</div>`;
  }
}

async function dryRun(project){
  const el=document.getElementById('update-result');
  el.innerHTML='<div class="update-result"><span class="spinner"></span> Generating commands...</div>';
  try{
    const [r1,r2]=await Promise.all([
      fetch('/api/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({project,level:'minor',dryRun:true})}),
      fetch('/api/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({project,level:'latest',dryRun:true})})
    ]);
    const [d1,d2]=await Promise.all([r1.json(),r2.json()]);
    el.innerHTML=`<div class="update-result">
      <strong>Commands preview</strong><br><br>
      <div style="margin-bottom:10px"><span style="color:var(--ok)">Safe update (patch + minor):</span><br><span class="cmd">$ ${esc(d1.command)}</span></div>
      <div><span style="color:var(--danger)">Full update (latest):</span><br><span class="cmd">$ ${esc(d2.command)}</span></div>
    </div>`;
  }catch(e){
    el.innerHTML=`<div class="update-result">Error: ${esc(e.message)}</div>`;
  }
}

async function toggleAutoUpdate(project, enabled){
  try{
    await fetch('/api/autoupdate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({project,enabled})});
    await loadAutoUpdate();
  }catch(e){console.error(e)}
}

async function updateAllProjects(){
  const btn=document.getElementById('update-all-btn');
  btn.disabled=true;
  btn.innerHTML='<span class="spinner"></span>Updating...';

  const toUpdate=allProjects.filter(p=>p.outdatedCount>0);
  if(!toUpdate.length){btn.disabled=false;btn.innerHTML='â¬† Update All Projects';return}

  // Show progress overlay
  let overlay=document.getElementById('update-all-overlay');
  if(!overlay){
    overlay=document.createElement('div');
    overlay.id='update-all-overlay';
    overlay.style.cssText='position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:200;display:flex;align-items:center;justify-content:center';
    document.body.appendChild(overlay);
  }

  const panel=document.createElement('div');
  panel.style.cssText='background:var(--card);border:1px solid var(--border);border-radius:14px;padding:28px;width:520px;max-height:80vh;overflow-y:auto';
  panel.innerHTML='<h2 style="margin-bottom:16px;font-size:18px">Updating '+toUpdate.length+' projects...</h2><div id="update-progress"></div>';
  overlay.innerHTML='';
  overlay.appendChild(panel);

  const progress=document.getElementById('update-progress');
  const results=[];

  for(let i=0;i<toUpdate.length;i++){
    const proj=toUpdate[i];
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)';
    row.innerHTML='<span class="spinner"></span><span style="flex:1">'+esc(proj.project)+'</span><span style="color:var(--dim);font-size:12px">'+(i+1)+'/'+toUpdate.length+'</span>';
    progress.appendChild(row);

    try{
      const r=await fetch('/api/update',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({project:proj.project,level:'minor'})});
      const d=await r.json();
      const ok=d.success!==false;
      results.push({project:proj.project,success:ok});
      row.innerHTML=(ok?'<span style="color:var(--ok);font-size:18px">âœ“</span>':'<span style="color:var(--danger);font-size:18px">âœ—</span>')+
        '<span style="flex:1">'+esc(proj.project)+'</span>'+
        '<span style="color:var(--dim);font-size:12px">'+(ok?'updated':'failed')+'</span>';
    }catch(e){
      results.push({project:proj.project,success:false});
      row.innerHTML='<span style="color:var(--danger);font-size:18px">âœ—</span><span style="flex:1">'+esc(proj.project)+'</span><span style="color:var(--dim);font-size:12px">error</span>';
    }
  }

  const ok=results.filter(r=>r.success).length;
  const fail=results.filter(r=>!r.success).length;
  const summary=document.createElement('div');
  summary.style.cssText='margin-top:16px;display:flex;justify-content:space-between;align-items:center';
  summary.innerHTML='<span style="font-size:14px"><strong style="color:var(--ok)">'+ok+' updated</strong>'+(fail?' Â· <strong style="color:var(--danger)">'+fail+' failed</strong>':'')+'</span>'+
    '<button class="btn btn-primary btn-sm" onclick="document.getElementById(\'update-all-overlay\').remove();triggerScan()">Close & Rescan</button>';
  progress.appendChild(summary);

  btn.disabled=false;
  btn.innerHTML='â¬† Update All Projects';
}

async function triggerScan(){
  const btn=document.getElementById('scan-btn');
  btn.disabled=true;
  btn.innerHTML='<span class="spinner"></span>Scanning...';
  try{
    await fetch('/api/scan',{method:'POST'});
    const poll=setInterval(async()=>{
      try{
        const r=await fetch('/api/status');
        const d=await r.json();
        renderOverview(d);
        if(!d.scanning){clearInterval(poll);loadData()}
      }catch(e){clearInterval(poll)}
    },2000);
  }catch(e){
    console.error(e);
    btn.disabled=false;
    btn.innerHTML='âŸ³ Scan All Projects';
  }
}

// â”€â”€ Init â”€â”€
loadData();
setInterval(loadData,30000);
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeDetail()});
</script>
</body></html>
